# Copyright 2020 RICOS Co. Ltd.
#
# This file is a part of ricosjp/allgebra, distributed under Apache-2.0 License
# https://github.com/ricosjp/allgebra

# This file is automatically generated by allgebra_template/gen_allgebra.sh

FROM nvidia/cuda:${CUDA_MAJOR}.${CUDA_MINOR}.${CUDA_PATCH}-devel-ubuntu${OS_VERSION}

# workaround for tzdata
ENV DEBIAN_FRONTEND=noninteractive

# Keep package list sorted
RUN apt-get update && apt-get install -y \\
    ccache \\
    curl \\
    doxygen \\
    clang-format \\
    clang-tidy \\
    g++-${GCC_MAJOR} \\
    gfortran-${GCC_MAJOR} \\
    git \\
    graphviz \\
    libelf-dev \\
    make \\
    ninja-build \\
    patchelf \\
    pkg-config \\
    python3 \\
    python3-pip \\
    && apt-get clean \\
    && rm -rf /var/lib/apt/lists/*

RUN pip3 install \"poetry==1.1.7\"

# Override GCC${GCC_MAJOR} by GCC
RUN rm -f /usr/bin/gcc /usr/bin/g++ /usr/bin/gfortran \\
    && ln -s /usr/bin/gcc-${GCC_MAJOR} /usr/bin/gcc \\
    && ln -s /usr/bin/g++-${GCC_MAJOR} /usr/bin/g++ \\
    && ln -s /usr/bin/gfortran-${GCC_MAJOR} /usr/bin/gfortran

RUN curl -LO https://github.com/Kitware/CMake/releases/download/v${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}/cmake-${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}-linux-x86_64.tar.gz \\
    && tar xf cmake-${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}-linux-x86_64.tar.gz \\
    && mv cmake-${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}-linux-x86_64/bin/* /usr/bin/ \\
    && mv cmake-${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}-linux-x86_64/share/cmake-${CMAKE_MAJOR}.${CMAKE_MINOR} /usr/share/ \\
    && rm -rf cmake-${CMAKE_MAJOR}.${CMAKE_MINOR}.${CMAKE_PATCH}-linux-x86_64*

# CUDA ${CUDA_MAJOR}.${CUDA_MINOR} environements
ENV CPATH              /usr/local/cuda-${CUDA_MAJOR}.${CUDA_MINOR}/include
ENV C_INCLUDE_PATH     /usr/local/cuda-${CUDA_MAJOR}.${CUDA_MINOR}/include
ENV CPLUS_INCLUDE_PATH /usr/local/cuda-${CUDA_MAJOR}.${CUDA_MINOR}/include

# Singurality \`--nv\` option tries to mount host's \`libcuda.so\` at \`/.singurality.d/libs\`, which \`ld\` does not search.
# This is not necessary for Docker's \`--gpus=all\` since it mounts them where ld can find e.g. \`/usr/lib/x86_64-linux-gnu/\`.
ENV LIBRARY_PATH /usr/local/cuda-${CUDA_MAJOR}.${CUDA_MINOR}/lib64:/.singularity.d/libs/

# To validate container is well-constructed
COPY examples/ /examples

# Utility for allgebra
COPY utilities /utilities
RUN make -C /utilities install

# Setting git config
RUN echo \"[safe]\\n\\tdirectory = *\" > /root/.gitconfig
COPY check_format.sh /usr/bin

ENV ALLGEBRA_CUDA_INSTALL_DIR /usr/local/cuda-${CUDA_MAJOR}.${CUDA_MINOR}
ENV ALLGEBRA_CUDA_VERSION ${CUDA_MAJOR}.${CUDA_MINOR}.${CUDA_PATCH}
ENV ALLGEBRA_CUDA_VERSION_MAJOR ${CUDA_MAJOR}
ENV ALLGEBRA_CUDA_VERSION_MINOR ${CUDA_MINOR}
ENV ALLGEBRA_CUDA_VERSION_PATCH ${CUDA_PATCH}
